"use strict";

exports.__esModule = true;
exports.generate = generate;

var _mkdirp = require("mkdirp");

var _path = require("path");

var _crypto = require("crypto");

var _hooks = require("./hooks");

var _codegen = require("./codegen");

var _watcher = require("./utils/watcher");

var _fileSystem = require("./utils/file-system");

var _debugging = require("./utils/debugging");

const hash = content => (0, _crypto.createHash)('sha1').update(content).digest('base64');

async function generate(config, saveToFile = true) {
  await (0, _hooks.lifecycleHooks)(config.hooks).afterStart();
  let recentOutputHash = new Map();

  async function writeOutput(generationResult) {
    if (!saveToFile) {
      return generationResult;
    }

    await (0, _hooks.lifecycleHooks)(config.hooks).beforeAllFileWrite(generationResult.map(r => r.filename));
    await Promise.all(generationResult.map(async result => {
      const exists = (0, _fileSystem.fileExists)(result.filename);

      if (!shouldOverwrite(config, result.filename) && exists) {
        return;
      }

      const content = result.content || '';
      const currentHash = hash(content);
      let previousHash = recentOutputHash.get(result.filename);

      if (!previousHash && exists) {
        previousHash = hash((0, _fileSystem.readSync)(result.filename));
      }

      if (previousHash && currentHash === previousHash) {
        (0, _debugging.debugLog)(`Skipping file (${result.filename}) writing due to indentical hash...`);
        return;
      }

      if (content.length === 0) {
        return;
      }

      recentOutputHash.set(result.filename, currentHash);
      const basedir = (0, _path.dirname)(result.filename);
      await (0, _hooks.lifecycleHooks)(result.hooks).beforeOneFileWrite(result.filename);
      await (0, _hooks.lifecycleHooks)(config.hooks).beforeOneFileWrite(result.filename);
      (0, _mkdirp.sync)(basedir);
      (0, _fileSystem.writeSync)(result.filename, result.content);
      await (0, _hooks.lifecycleHooks)(result.hooks).afterOneFileWrite(result.filename);
      await (0, _hooks.lifecycleHooks)(config.hooks).afterOneFileWrite(result.filename);
    }));
    await (0, _hooks.lifecycleHooks)(config.hooks).afterAllFileWrite(generationResult.map(r => r.filename));
    return generationResult;
  } // watch mode


  if (config.watch) {
    return (0, _watcher.createWatcher)(config, writeOutput);
  }

  const outputFiles = await (0, _codegen.executeCodegen)(config);
  await writeOutput(outputFiles);
  (0, _hooks.lifecycleHooks)(config.hooks).beforeDone();
  return outputFiles;
}

function shouldOverwrite(config, outputPath) {
  const globalValue = config.overwrite === undefined ? true : !!config.overwrite;
  const outputConfig = config.generates[outputPath];

  if (!outputConfig) {
    (0, _debugging.debugLog)(`Couldn't find a config of ${outputPath}`);
    return globalValue;
  }

  if (isConfiguredOutput(outputConfig) && typeof outputConfig.overwrite === 'boolean') {
    return outputConfig.overwrite;
  }

  return globalValue;
}

function isConfiguredOutput(output) {
  return typeof output.plugins !== 'undefined';
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jb2RlZ2VuL2dlbmVyYXRlLWFuZC1zYXZlLnRzIl0sIm5hbWVzIjpbImhhc2giLCJjb250ZW50IiwidXBkYXRlIiwiZGlnZXN0IiwiZ2VuZXJhdGUiLCJjb25maWciLCJzYXZlVG9GaWxlIiwiaG9va3MiLCJhZnRlclN0YXJ0IiwicmVjZW50T3V0cHV0SGFzaCIsIk1hcCIsIndyaXRlT3V0cHV0IiwiZ2VuZXJhdGlvblJlc3VsdCIsImJlZm9yZUFsbEZpbGVXcml0ZSIsIm1hcCIsInIiLCJmaWxlbmFtZSIsIlByb21pc2UiLCJhbGwiLCJyZXN1bHQiLCJleGlzdHMiLCJzaG91bGRPdmVyd3JpdGUiLCJjdXJyZW50SGFzaCIsInByZXZpb3VzSGFzaCIsImdldCIsImxlbmd0aCIsInNldCIsImJhc2VkaXIiLCJiZWZvcmVPbmVGaWxlV3JpdGUiLCJhZnRlck9uZUZpbGVXcml0ZSIsImFmdGVyQWxsRmlsZVdyaXRlIiwid2F0Y2giLCJvdXRwdXRGaWxlcyIsImJlZm9yZURvbmUiLCJvdXRwdXRQYXRoIiwiZ2xvYmFsVmFsdWUiLCJvdmVyd3JpdGUiLCJ1bmRlZmluZWQiLCJvdXRwdXRDb25maWciLCJnZW5lcmF0ZXMiLCJpc0NvbmZpZ3VyZWRPdXRwdXQiLCJvdXRwdXQiLCJwbHVnaW5zIl0sIm1hcHBpbmdzIjoiOzs7OztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUlBLE1BQU1BLElBQUksR0FBSUMsT0FBRCxJQUNYLHdCQUFXLE1BQVgsRUFDR0MsTUFESCxDQUNVRCxPQURWLEVBRUdFLE1BRkgsQ0FFVSxRQUZWLENBREY7O0FBS08sZUFBZUMsUUFBZixDQUF3QkMsTUFBeEIsRUFBOENDLFVBQVUsR0FBRyxJQUEzRCxFQUFvRztBQUN6RyxRQUFNLDJCQUFlRCxNQUFNLENBQUNFLEtBQXRCLEVBQTZCQyxVQUE3QixFQUFOO0FBQ0EsTUFBSUMsZ0JBQWdCLEdBQUcsSUFBSUMsR0FBSixFQUF2Qjs7QUFF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LENBQXlCaEIsTUFBekIsRUFBK0M2QixVQUEvQyxFQUE0RTtBQUMxRSxRQUFNQyxXQUFXLEdBQUc5QixNQUFNLENBQUMrQixTQUFQLEtBQXFCQyxTQUFyQixHQUFpQyxJQUFqQyxHQUF3QyxDQUFDLENBQUNoQyxNQUFNLENBQUMrQixTQUFyRTtBQUNBLFFBQU1FLFlBQVksR0FBR2pDLE1BQU0sQ0FBQ2tDLFNBQVAsQ0FBaUJMLFVBQWpCLENBQXJCOztBQUVBLE1BQUksQ0FBQ0ksWUFBTCxFQUFtQjtBQUNqQiw2QkFBVSw2QkFBNEJKLFVBQVcsRUFBakQ7QUFDQSxXQUFPQyxXQUFQO0FBQ0Q7O0FBRUQsTUFBSUssa0JBQWtCLENBQUNGLFlBQUQsQ0FBbEIsSUFBb0MsT0FBT0EsWUFBWSxDQUFDRixTQUFwQixLQUFrQyxTQUExRSxFQUFxRjtBQUNuRixXQUFPRSxZQUFZLENBQUNGLFNBQXBCO0FBQ0Q7O0FBRUQsU0FBT0QsV0FBUDtBQUNEOztBQUVELFNBQVNLLGtCQUFULENBQTRCQyxNQUE1QixFQUEyRTtBQUN6RSxTQUFPLE9BQU9BLE1BQU0sQ0FBQ0MsT0FBZCxLQUEwQixXQUFqQztBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVHlwZXMgfSBmcm9tICdAZ3JhcGhxbC1jb2RlZ2VuL3BsdWdpbi1oZWxwZXJzJztcbmltcG9ydCB7IHN5bmMgYXMgbWtkaXJwU3luYyB9IGZyb20gJ21rZGlycCc7XG5pbXBvcnQgeyBkaXJuYW1lIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBjcmVhdGVIYXNoIH0gZnJvbSAnY3J5cHRvJztcblxuaW1wb3J0IHsgbGlmZWN5Y2xlSG9va3MgfSBmcm9tICcuL2hvb2tzJztcbmltcG9ydCB7IGV4ZWN1dGVDb2RlZ2VuIH0gZnJvbSAnLi9jb2RlZ2VuJztcbmltcG9ydCB7IGNyZWF0ZVdhdGNoZXIgfSBmcm9tICcuL3V0aWxzL3dhdGNoZXInO1xuaW1wb3J0IHsgZmlsZUV4aXN0cywgcmVhZFN5bmMsIHdyaXRlU3luYyB9IGZyb20gJy4vdXRpbHMvZmlsZS1zeXN0ZW0nO1xuaW1wb3J0IHsgZGVidWdMb2cgfSBmcm9tICcuL3V0aWxzL2RlYnVnZ2luZyc7XG5pbXBvcnQgeyBEb2N1bWVudE5vZGUgfSBmcm9tICdncmFwaHFsJztcbmltcG9ydCB7IEN1c3RvbUNvbmZpZyB9IGZyb20gJy4vY29uZmlnJztcblxuY29uc3QgaGFzaCA9IChjb250ZW50OiBzdHJpbmcpOiBzdHJpbmcgPT5cbiAgY3JlYXRlSGFzaCgnc2hhMScpXG4gICAgLnVwZGF0ZShjb250ZW50KVxuICAgIC5kaWdlc3QoJ2Jhc2U2NCcpO1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGUoY29uZmlnOiBDdXN0b21Db25maWcsIHNhdmVUb0ZpbGUgPSB0cnVlKTogUHJvbWlzZTxUeXBlcy5GaWxlT3V0cHV0W10gfCBhbnk+IHtcbiAgYXdhaXQgbGlmZWN5Y2xlSG9va3MoY29uZmlnLmhvb2tzKS5hZnRlclN0YXJ0KCk7XG4gIGxldCByZWNlbnRPdXRwdXRIYXNoID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcblxuICBhc3luYyBmdW5jdGlvbiB3cml0ZU91dHB1dChnZW5lcmF0aW9uUmVzdWx0OiBUeXBlcy5GaWxlT3V0cHV0W10pIHtcbiAgICBpZiAoIXNhdmVUb0ZpbGUpIHtcbiAgICAgIHJldHVybiBnZW5lcmF0aW9uUmVzdWx0O1xuICAgIH1cblxuICAgIGF3YWl0IGxpZmVjeWNsZUhvb2tzKGNvbmZpZy5ob29rcykuYmVmb3JlQWxsRmlsZVdyaXRlKGdlbmVyYXRpb25SZXN1bHQubWFwKHIgPT4gci5maWxlbmFtZSkpO1xuXG4gICAgYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICBnZW5lcmF0aW9uUmVzdWx0Lm1hcChhc3luYyAocmVzdWx0OiBUeXBlcy5GaWxlT3V0cHV0KSA9PiB7XG4gICAgICAgIGNvbnN0IGV4aXN0cyA9IGZpbGVFeGlzdHMocmVzdWx0LmZpbGVuYW1lKTtcblxuICAgICAgICBpZiAoIXNob3VsZE92ZXJ3cml0ZShjb25maWcsIHJlc3VsdC5maWxlbmFtZSkgJiYgZXhpc3RzKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY29udGVudCA9IHJlc3VsdC5jb250ZW50IHx8ICcnO1xuICAgICAgICBjb25zdCBjdXJyZW50SGFzaCA9IGhhc2goY29udGVudCk7XG4gICAgICAgIGxldCBwcmV2aW91c0hhc2ggPSByZWNlbnRPdXRwdXRIYXNoLmdldChyZXN1bHQuZmlsZW5hbWUpO1xuXG4gICAgICAgIGlmICghcHJldmlvdXNIYXNoICYmIGV4aXN0cykge1xuICAgICAgICAgIHByZXZpb3VzSGFzaCA9IGhhc2gocmVhZFN5bmMocmVzdWx0LmZpbGVuYW1lKSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocHJldmlvdXNIYXNoICYmIGN1cnJlbnRIYXNoID09PSBwcmV2aW91c0hhc2gpIHtcbiAgICAgICAgICBkZWJ1Z0xvZyhgU2tpcHBpbmcgZmlsZSAoJHtyZXN1bHQuZmlsZW5hbWV9KSB3cml0aW5nIGR1ZSB0byBpbmRlbnRpY2FsIGhhc2guLi5gKTtcblxuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb250ZW50Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHJlY2VudE91dHB1dEhhc2guc2V0KHJlc3VsdC5maWxlbmFtZSwgY3VycmVudEhhc2gpO1xuICAgICAgICBjb25zdCBiYXNlZGlyID0gZGlybmFtZShyZXN1bHQuZmlsZW5hbWUpO1xuICAgICAgICBhd2FpdCBsaWZlY3ljbGVIb29rcyhyZXN1bHQuaG9va3MpLmJlZm9yZU9uZUZpbGVXcml0ZShyZXN1bHQuZmlsZW5hbWUpO1xuICAgICAgICBhd2FpdCBsaWZlY3ljbGVIb29rcyhjb25maWcuaG9va3MpLmJlZm9yZU9uZUZpbGVXcml0ZShyZXN1bHQuZmlsZW5hbWUpO1xuICAgICAgICBta2RpcnBTeW5jKGJhc2VkaXIpO1xuICAgICAgICB3cml0ZVN5bmMocmVzdWx0LmZpbGVuYW1lLCByZXN1bHQuY29udGVudCk7XG4gICAgICAgIGF3YWl0IGxpZmVjeWNsZUhvb2tzKHJlc3VsdC5ob29rcykuYWZ0ZXJPbmVGaWxlV3JpdGUocmVzdWx0LmZpbGVuYW1lKTtcbiAgICAgICAgYXdhaXQgbGlmZWN5Y2xlSG9va3MoY29uZmlnLmhvb2tzKS5hZnRlck9uZUZpbGVXcml0ZShyZXN1bHQuZmlsZW5hbWUpO1xuICAgICAgfSksXG4gICAgKTtcblxuICAgIGF3YWl0IGxpZmVjeWNsZUhvb2tzKGNvbmZpZy5ob29rcykuYWZ0ZXJBbGxGaWxlV3JpdGUoZ2VuZXJhdGlvblJlc3VsdC5tYXAociA9PiByLmZpbGVuYW1lKSk7XG5cbiAgICByZXR1cm4gZ2VuZXJhdGlvblJlc3VsdDtcbiAgfVxuXG4gIC8vIHdhdGNoIG1vZGVcbiAgaWYgKGNvbmZpZy53YXRjaCkge1xuICAgIHJldHVybiBjcmVhdGVXYXRjaGVyKGNvbmZpZywgd3JpdGVPdXRwdXQpO1xuICB9XG5cbiAgY29uc3Qgb3V0cHV0RmlsZXMgPSBhd2FpdCBleGVjdXRlQ29kZWdlbihjb25maWcpO1xuXG4gIGF3YWl0IHdyaXRlT3V0cHV0KG91dHB1dEZpbGVzKTtcblxuICBsaWZlY3ljbGVIb29rcyhjb25maWcuaG9va3MpLmJlZm9yZURvbmUoKTtcblxuICByZXR1cm4gb3V0cHV0RmlsZXM7XG59XG5cbmZ1bmN0aW9uIHNob3VsZE92ZXJ3cml0ZShjb25maWc6IEN1c3RvbUNvbmZpZywgb3V0cHV0UGF0aDogc3RyaW5nKTogYm9vbGVhbiB7XG4gIGNvbnN0IGdsb2JhbFZhbHVlID0gY29uZmlnLm92ZXJ3cml0ZSA9PT0gdW5kZWZpbmVkID8gdHJ1ZSA6ICEhY29uZmlnLm92ZXJ3cml0ZTtcbiAgY29uc3Qgb3V0cHV0Q29uZmlnID0gY29uZmlnLmdlbmVyYXRlc1tvdXRwdXRQYXRoXTtcblxuICBpZiAoIW91dHB1dENvbmZpZykge1xuICAgIGRlYnVnTG9nKGBDb3VsZG4ndCBmaW5kIGEgY29uZmlnIG9mICR7b3V0cHV0UGF0aH1gKTtcbiAgICByZXR1cm4gZ2xvYmFsVmFsdWU7XG4gIH1cblxuICBpZiAoaXNDb25maWd1cmVkT3V0cHV0KG91dHB1dENvbmZpZykgJiYgdHlwZW9mIG91dHB1dENvbmZpZy5vdmVyd3JpdGUgPT09ICdib29sZWFuJykge1xuICAgIHJldHVybiBvdXRwdXRDb25maWcub3ZlcndyaXRlO1xuICB9XG5cbiAgcmV0dXJuIGdsb2JhbFZhbHVlO1xufVxuXG5mdW5jdGlvbiBpc0NvbmZpZ3VyZWRPdXRwdXQob3V0cHV0OiBhbnkpOiBvdXRwdXQgaXMgVHlwZXMuQ29uZmlndXJlZE91dHB1dCB7XG4gIHJldHVybiB0eXBlb2Ygb3V0cHV0LnBsdWdpbnMgIT09ICd1bmRlZmluZWQnO1xufVxuIl19